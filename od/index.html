<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width" />
    <title>ncnn webassembly nanodet camera</title>
    <style>
        video {
/*             position: absolute; */
/*             visibility: hidden; */
        }
        canvas {
            border: 1px solid black;
        }
    </style>

</head>

<body>
    <div>
        <h1>ncnn webassembly nanodet camera</h1>
        <div>
            <button disabled id="switch-camera-btn" style="height:48px">Switch Camera</button>
        </div>
        <div>
            <video id="video" playsinline autoplay></video>
            <canvas id="canvas" width="640"></canvas>
        </div>
        <div id="output"></div>
    </div>

    <script src="wasmFeatureDetect.js"></script>

    <script type='text/javascript'>
        var Module = {};

        var has_simd;

        var wasmModuleLoaded = false;
        var wasmModuleLoadedCallbacks = [];

        Module.onRuntimeInitialized = function() {
            wasmModuleLoaded = true;
            for (var i = 0; i < wasmModuleLoadedCallbacks.length; i++) {
                wasmModuleLoadedCallbacks[i]();
            }
        }

        wasmFeatureDetect.simd().then(simdSupported => {
            has_simd = simdSupported;

            if (has_simd) {
                nanodet_module_name = 'nanodet-simd';
            } else {
                nanodet_module_name = 'nanodet-basic';
            }

            console.log('load ' + nanodet_module_name);

            var nanodetwasm = nanodet_module_name + '.wasm';
            var nanodetjs = nanodet_module_name + '.js';

            fetch(nanodetwasm)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    Module.wasmBinary = buffer;
                    var script = document.createElement('script');
                    script.src = nanodetjs;
                    script.onload = function() {
                        console.log('Emscripten boilerplate loaded.');
                    }
                    document.body.appendChild(script);
                });
        });

        var shouldFaceUser = true;
        var stream = null;
        var w = 640;
        var h = 480;
        

        var imageDataBuffer = null;
        var resultarray = null;
        var resultbuffer = null;

        var OBJECT_CLASSES = {
            PERSON: 'person',
            LAPTOP: 'laptop',
            CELL_PHONE: 'cell_phone'
        };
    
        var OBJECT_CLASS_LABELS = {
            1: this.OBJECT_CLASSES.PERSON,
            64: this.OBJECT_CLASSES.LAPTOP,
            68: this.OBJECT_CLASSES.CELL_PHONE
        };

        const MAX_DETECTIONS = 5;

        window.addEventListener('DOMContentLoaded', function() {
            var isStreaming = false;
            switchcamerabtn = document.getElementById('switch-camera-btn');
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            // Wait until the video stream canvas play
            video.addEventListener('canplay', function(e) {
                if (!isStreaming) {
                    // videoWidth isn't always set correctly in all browsers
                    if (video.videoWidth > 0) h = video.videoHeight / (video.videoWidth / w);
                    canvas.setAttribute('width', w);
                    canvas.setAttribute('height', h);
                    isStreaming = true;
                }
            }, false);

            // Wait for the video to start to play
            video.addEventListener('play', function() {
                //Setup image memory
                var id = ctx.getImageData(0, 0, canvas.width, canvas.height);
                var d = id.data;

                if (wasmModuleLoaded) {
                    mallocAndCallSFilter();
                } else {
                    wasmModuleLoadedCallbacks.push(mallocAndCallSFilter);
                }

                function mallocAndCallSFilter() {
                    if (imageDataBuffer != null)
                    {
                        _free(imageDataBuffer);
                        imageDataBuffer = null;
                    }

                    imageDataBuffer = _malloc(d.length);

                    //console.log("What " + d.length);

                    sFilter();
                }
            });

            // check whether we can use facingMode
            var supports = navigator.mediaDevices.getSupportedConstraints();
            if (supports['facingMode'] === true) {
                switchcamerabtn.disabled = false;
            }

            switchcamerabtn.addEventListener('click', function() {
                if (stream == null)
                    return

                stream.getTracks().forEach(t => {
                    t.stop();
                });

                shouldFaceUser = !shouldFaceUser;
                capture();
            });

            capture();
        });

        function capture() {
            var constraints = { audio: false, video: { width: 640, height: 480, facingMode: shouldFaceUser ? 'user' : 'environment' } };
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(mediaStream) {
                    var video = document.querySelector('video');
                    stream = mediaStream;
                    video.srcObject = mediaStream;
                    video.onloadedmetadata = function(e) {
                        video.play();
                    };
                })
                .catch(function(err) {
                    console.log(err.message);
                });
        }

        function ncnn_nanodet() {
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');

            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            HEAPU8.set(imageData.data, imageDataBuffer);
            var output = "";

            let t1 = performance.now();
            _nanodet_ncnn(imageDataBuffer, canvas.width, canvas.height, resultbuffer);
            let t2 = performance.now();
            output += `Time taken: ${(t2 - t1) } ms`;

            var resultarray = HEAPU16.subarray(
                resultbuffer / Uint16Array.BYTES_PER_ELEMENT,
                resultbuffer / Uint16Array.BYTES_PER_ELEMENT + 6 * MAX_DETECTIONS,
            );

            for (let i = 0; i < MAX_DETECTIONS; i++) {
                var label = resultarray[i * 6 + 0];
                var prob = resultarray[i * 6 + 1];
                var bbox_x = resultarray[i * 6 + 2];
                var bbox_y = resultarray[i * 6 + 3];
                var bbox_w = resultarray[i * 6 + 4];
                var bbox_h = resultarray[i * 6 + 5];

                // Label 0 means that no object was detected
                if (label == 0 || !OBJECT_CLASS_LABELS[label])
                    continue;

                output += ', Class: ' + OBJECT_CLASS_LABELS[label] + ', Probability: ' + prob + "%";
                document.getElementById("output").innerHTML = output; 
                console.log(output);

                ctx.strokeStyle = 'rgba(0, 0, 255, 0.6)';
                ctx.strokeRect(bbox_x, bbox_y, bbox_w, bbox_h);

                var text = OBJECT_CLASS_LABELS[label] + " = " + parseFloat(prob).toFixed(2) + "%";

                ctx.textBaseline = 'top';
                var text_width = ctx.measureText(text).width;
                var text_height = parseInt(ctx.font, 10);

                var x = bbox_x;
                var y = bbox_y - text_height;
                if (y < 0)
                    y = 0;
                if (x + text_width > canvas.width)
                    x = canvas.width - text_width;

                ctx.fillStyle = "rgb(255,255,255)";
                ctx.fillRect(x, y, text_width, text_height);
                ctx.font = "20pt Arial";
                ctx.fillStyle = "rgb(0,0,0)";
                ctx.fillText(text, x, y);
            }
        }

        //Request Animation Frame function
        var sFilter = function() {
            if (video.paused || video.ended) return;

            ctx.fillRect(0, 0, w, h);
            ctx.drawImage(video, 0, 0, w, h);

            ncnn_nanodet();

            window.requestAnimationFrame(sFilter);
        }

    </script>

</body>

</html>
